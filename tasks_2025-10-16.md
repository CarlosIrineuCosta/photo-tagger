# Tasks — 2025-10-16 (Authoritative, Merged)

> **North star:** Fast reviewer UX (3+1 actions), higher-precision tags via tiered labels, and optional RAW + style probe. Keep Streamlit simple and performant.

---

## ✅ Completed (context)

1. Pin deps (`numpy<1.25`, `scipy>=1.11.4`) in pyproject.
2. `clip_model.py` uses AMP; embeddings validated.
3. Filter spurious “can” via `_DISALLOWED` in `labels.py`.
4. UI copy: “Top-K → Labels per image”, lock model name, add threshold tooltip.
5. Streamlit mock layout (`tests/mock_layout.py`) illustrates Gallery vs. Config tabs with footer log.

---

## ☑︎ Checklist Snapshot (2025-10-17)

- [x] Command/status strip tightened; gallery owns main scroll (pending final layout approval).
- [x] On-demand square thumbnails with center-crop toggle (needs spacing polish).
- [x] Medoid/unapproved/hide toggles + pagination wired to session state.
- [ ] Replace header layout per upcoming Photoshop mock (controls must vacate gallery area).
- [ ] Refine gallery spacing (remove “white blob” separators, light dividers if any).
- [ ] Finish label chips + filename clamp, migrate remaining widgets from `use_container_width`.
- [ ] Validate medoid highlighting against structured folder dataset.
- [ ] Revisit sidebar/config entry based on PS mock (Gallery vs Config navigation).
- [ ] Freeze bottom status footer (two-line toast replacement) after layout sign-off.

---

## A. UX Overhaul (QHD-ready) — “3+1” model

**A1. Fixed Command + Status Bar (main pane, not sidebar)**

* Buttons: **Process images** → (Scan+Thumbs+Embed+Score+Medoids) • **Medoids only** toggle • **Only unapproved** toggle • **Save approved & clear** • **Export CSV & Sidecars** (dropdown: CSV only / Sidecars only / Both).
* Status strip under buttons (last 20 events).
* All messages go here; gallery never shows messages.

**A2. Single scroll region**

* Gallery lives in its own scroll container; the Command/Status bar is fixed.

**A3. Sidebar = configuration only (dense)**

* Root path (validated + recents), Labels file (picker or validated path), Labels per image (Top-K), Max images, Include RAW toggle.
* ± steppers inline with labels (same row).
* Remove action buttons from sidebar.

**A4. Grid uniformity & density**

* Square thumbs 320×320 (letterbox by default, toggle for center-crop).
* Filename clamp to **1 line + ellipsis**, tooltip shows full path, copy-path icon.
* Top-K as **toggle chips**; “More labels” collapsible uses tight checkboxes (small line-height/gaps).
* Target: ≥6 cards/row on QHD (sidebar open).
* _Progress:_ command bar trimmed, medoid badges and pagination live; square thumb rendering + center-crop toggle wired. Remaining: chips UI + filename clamp tweaks.

**A5. Pagination & filters**

* Page sizes 24/48/96; approvals persist across pages.
* Filters (medoids only / unapproved) live in Command Bar.

**A6. Save behavior**

* Toggle: **Hide after save** removes saved cards from current view immediately.

**A7. Styling & API hygiene**

* Replace `use_container_width` with `width='stretch'|'content'`.
* `_styles.css`: `.pt-fn` (filename clamp), `.pt-chips` (chip row), `.pt-tight` (compact checks), status strip, card spacing.
* Central `append_status(level,msg)` used instead of raw `st.success/info`.

---

## Progress Notes — 2025-10-17

- Command bar + status strip slimmed; gallery now owns vertical scroll but still shares top real estate with controls (see Photo Tagger 10-16 mock). Further layout change pending new mockup.
- Thumbnail rendering supplies square crops on demand; spacing and visual dividers need refinement (goal: subtle gray separators or compressed gutters).
- Gallery filters (medoids/unapproved/hide-after-save) and pagination toggle state correctly; label chips + filename clamps remain to-do.
- Medoid flagging tied to resolved paths; needs validation against structured folder test set.

---

## B. Pipeline Simplification (from 5 buttons to 3+1)

**B1. One-shot processing**

* `process_images()` chains Scan → Thumbs (missing only) → Embed → Score → Medoids; emits a single summary entry (counts + elapsed).

**B2. Reviewer step**

* User selects tags directly in grid; Top-K quick-approve chip.

**B3. Save step**

* **Save approved & clear** (respects Hide-after-save).

**B4. Export step**

* **Export CSV & Sidecars** combined; dropdown supports CSV-only or Sidecars-only.

---

## C. Tiered Labels & Precision Boost

**C1. Repo additions**

```
labels/
  objects.txt, scenes.txt, styles.txt, candidates.txt
  thresholds.yaml, equivalences.yaml, prompts.yaml
app/core/
  tiers.py
  expansion.py
```

*(use the starter files you drafted; commit as baseline)*

**C2. Tiers loader (`app/core/tiers.py`)**

* `load_tier_labels(labels_dir) -> {tier:[labels]}`
* `load_prompts(labels_dir) -> {tier:[templates]}`
* `load_thresholds(labels_dir) -> {tier_default:float, labels:{str:float}}`
* `embed_tier_labels(model, tokenizer, device, tiers, prompts) -> {tier: np.ndarray}`
* Cache per `(tier, model, prompts_hash, labels_hash)`.

**C3. Scoring API (non-breaking)**

* New: `score_tiers(img_emb, tier_txt_emb, tier_labels, thresholds) -> per_image{tier→[(label,score)…]}`.
* Keep legacy single-list scorer for compatibility.

**C4. Equivalence filtering**

* `apply_equivalences(per_image_scores, equivalences.yaml)`; keep max per group (e.g., `[bar,pub,restaurant,café]`, `[tanks,tank,armored vehicle]`).

**C5. Merge for UI & CSV**

* Combine tiered results into one list; annotate `label:tier` for coloring (Objects=blue, Scenes=orange, Styles=purple).
* CSV: add optional `approved_tiered_labels` (pipe `label:tier`).
* Sidecars remain flat labels only.

**C6. Multi-prompt embeddings**

* Use multiple templates per tier from `prompts.yaml` (avg their text embeddings) to stabilize style cues.

**C7. Optional semantic expansion (`app/core/expansion.py`)**

* On `use_expansion: true`, embed `candidates.txt` once (cache); suggest top-N unseen labels above `expansion_threshold`.
* UI shows suggested chips with outline; “Promote” adds to approved.

---

## D. RAW Support (optional but scoped)

**D1. Scan toggle**

* Include common RAW extensions when **Include RAW** is ON.

**D2. Thumbs**

* `rawpy` quick demosaic → RGB → 320×320 square; cache like JPEG/PNG.

**D3. Embeddings**

* Use in-memory demosaic tensor; no temp files.

**D4. Sidecars**

* Write `%d%f.xmp` against the RAW.

**D5. Packaging**

* Optional extra: `photo-tagger[raw]` installs `rawpy`.

---

## E. Label Hygiene & Grouping

**E1. Alias map & disallowed expansion**

* `_ALIASES` (e.g., `cellphone→phone`, `tv_monitor→monitor`).
* Expand `_DISALLOWED` (keep out junk/contextless).

**E2. UI grouping (visual only)**

* Collapsible groups: **Objects / Scenes / Styles**; color-coded.
* Doesn’t change storage; just improves reviewer scan speed.

---

## F. Cache & Ops

**F1. Purge thumbnail cache**

* Sidebar action + CLI `purge --thumbs`.
* Option: remove only thumbs not used in current run.

**F2. Merge Scan+Thumbs summaries**

* After `process_images()`, emit consolidated counts (N scanned, M new thumbs, elapsed).

---

## G. CLI & Config wiring

**G1. Config additions**

```yaml
labels_dir: "labels"
use_expansion: false
expansion_topk: 3
expansion_threshold: 0.29
use_style_probe: false
style_probe_path: "models/style_probe.joblib"
```

**G2. CLI flags**

```
--labels-dir
--use-expansion --expansion-topk --expansion-threshold
--use-style-probe --style-probe-path
--include-raw
```

**G3. Backward-compatible path**

* Flag to use legacy single-list scorer if needed.

---

## H. Style Probe (optional, separate day)

**H1. Train**

* LogisticRegression one-vs-rest on cached image embeddings; start with 4–6 styles (portrait, street photography, photojournalism, art photo, studio shot, abstract).
* Save `models/style_probe.joblib`.

**H2. Inference (guarded by `use_style_probe`)**

* Blend probe probabilities with CLIP style scores (avg or calibrated max).
* Only affects **Styles** tier.

---

## I. QA & Acceptance

**Functional**

* One-click **Process images** fills the grid; no mid-steps.
* Main scroll is gallery only; all messages in status strip.
* Approvals persist across pagination and filters.
* “Save approved & clear” removes cards when toggle ON.
* Export combined action works; CSV-only/Sidecars-only options work.

**Precision**

* Tiered scoring + equivalences reduce duplicate / near-synonym noise on a 200-image test.
* Style prompts surface expected style labels on portraits/street/PJ.

**Performance**

* Page switch <300 ms after warm-up (100–500 images).
* No Streamlit deprecation warnings.

**RAW (if enabled)**

* Mixed JPG+RAW folder processes without error; thumbs exist; sidecars written for RAW names.

---

## J. Documentation

**J1. README/UI updates**

* New 3+1 flow, Command/Status bar, pagination/filters, square-thumbs toggle, Hide-after-save, tier coloring, suggestions.
* QHD screenshots (horizontal + vertical).

**J2. `Tagging Accuracy Extensions.md`**

* Include tiers, thresholds, equivalences, multi-prompt rationale, semantic expansion, style probe outline.

---

## K. Order of Execution (paused pending mockup)

_Replan once Photoshop mock is delivered._

**UI Priorities (to re-sequence after mock)**

- Rework header/gallery layout per mock (likely Gallery vs Config navigation).
- Sidebar adjustments according to finalized layout.
- Gallery finishing pass (spacing, chips, filename clamp, medoid validation).
- Thumbnail pipeline decision (crop vs letterbox) based on mock feedback.
- Styling/API hygiene (remaining `width=` conversions), footer toast replacement.

**Deferred backlog (unchanged)**

- Cache purge action + CLI parity (F1).
- `tiers.py` loader + multi-prompt embeddings (C2, C6).
- Tiered scoring integration + UI colouring + equivalences (C3–C5).
- README/UI documentation refresh (J1).
- Optional expansion (C7), RAW support (D1–D5), style probe (H1–H2), Tagging Accuracy Extensions.md (J2).

---

## L. Guardrails

* If any task blocks, create `REPORT.md` (step, command, error, likely cause, proposed fix) and stop.
* Keep legacy scorer selectable to avoid blocking production runs.

---

## Hold Notice

- **USER ASKED TO STOP DEVELOPMENT UNTIL HE PROVIDES PHOTOSHOP MOCKUP.** Resume UI changes only after reviewing the forthcoming PS layout.

---

If you want me to also generate the **starter label files** (objects/scenes/styles/candidates + YAMLs) as ready-to-commit text blocks in a separate canvas or file, say the word and I’ll drop them in exactly as specified.
